{% extends "base.twig" %}

{% block content %}
  <div data-barba="container" data-barba-namespace="portfolio-page" class="{{body_class}}">
    <div class="content-wrapper" data-template="single-portfolio.twig">
      <article class="post-type-{{post.post_type}} portfolio">
        {# <header class="portfolio__header" style="background-image:url({{post.thumbnail.src('hd')}})">
          <h1 class="portfolio__title">{{post.title}}</h1>
        </header> #}
        <section class="portfolio__body-wrapper">
          <aside class="portfolio__sidebar"
            x-data="{
                open: false,
                selected: '{{post.meta('projects')[0].name}}',
                projectMap: { {% for project in post.meta('projects') %}'{{project.name|slugify}}': '{{project.name}}'{% if not loop.last %}, {% endif %}{% endfor %} },
                init() {
                    const hash = window.location.hash.slice(1);
                    if (hash && this.projectMap[hash]) {
                        this.selected = this.projectMap[hash];
                    }
                    this.$watch('selected', (value) => {
                        const slug = Object.keys(this.projectMap).find(key => this.projectMap[key] === value);
                        this.$dispatch('project-selected', { project: value, slug: slug });
                    });
                    // Dispatch initial event after a short delay to ensure listener is ready
                    setTimeout(() => {
                        const slug = Object.keys(this.projectMap).find(key => this.projectMap[key] === this.selected);
                        this.$dispatch('project-selected', { project: this.selected, slug: slug });
                    }, 100);
                },
                toggle() {
                    if (this.open) {
                        return this.close()
                    }
                    this.$refs.button.focus()
                    this.open = true
                },
                close(focusAfter) {
                    if (! this.open) return
                    this.open = false
                    focusAfter && focusAfter.focus()
                }
            }"
          >
            <nav class="works-nav works-nav--inline">
            {% for work in works %}
              {% if work.id == post.id %}
              <div class="current-work">
                <a class="works-nav__link works-nav__link--accent works-nav__link--current" href="{{work.link}}" data-target="#overlay-{{work.ID}}" alt="{{work.custom['main_description']}}">{{work.post_title}}</a>
                {% if post.meta('projects')|length > 1 %}
                <span class="works-nav__divider">/</span>
                <div class="works-nav__dropdown">
                    <div
                        x-on:keydown.escape.prevent.stop="close($refs.button)"
                        x-on:focusin.window="! $refs.panel.contains($event.target) && close()"
                        x-id="['dropdown-button']"
                        style="position: relative"
                    >
                        <!-- Button -->
                        <button
                          x-ref="button"
                          x-on:click="toggle()"
                          :aria-expanded="open"
                          :aria-controls="$id('dropdown-button')"
                          type="button"
                        >
                          <span x-text="selected"></span>

                          <!-- Heroicon: micro chevron-down -->
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                              <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                          </svg>
                        </button>

                        <!-- Panel -->
                        <div
                            x-ref="panel"
                            x-show="open"
                            x-transition.origin.top.left
                            x-on:click.outside="close($refs.button)"
                            :id="$id('dropdown-button')"
                            x-cloak
                            class="panel"
                        >
                          {% for project in post.meta('projects') %}
                            <a href="#{{project.name|slugify}}"
                               x-on:click="selected = '{{project.name}}'; close()"
                               class="">
                              {{project.name}}
                            </a>
                          {% endfor %}

                        </div>
                    </div>
                </div>
                {% endif %} 
              </div>
              {% endif %}
              {% if work.id != post.id %}
                <a class="works-nav__link works-nav__link--accent " href="{{work.link}}" data-target="#overlay-{{work.ID}}" alt="{{work.custom['main_description']}}">{{work.post_title}}</a>
              {% endif %}
            {% endfor %}
            </nav>
              <div class="portfolio__masonry">
                <div href="" class="portfolio__masonry-item-sizer"></div>
                {% for project in post.meta('projects') %}
                  <div class="portfolio__masonry-item portfolio__masonry-item--width3 portfolio__masonry-description" id="{{project.name|slugify}}" :class="{ 'filtered-out': selected !== '{{project.name}}' }">
                  <h2>{{project.name}}</h2>
                  {% if project.name != project.description %}
                    <h4>{{project.description}}</h4>
                  {% endif %}
                  </div>
                  {% for photo in project.photos %}
                    <div data-project="{{project.name|slugify}}" data-description="{{project.description}}" data-full-size="{{ photo.sizes.large }}" class="portfolio__masonry-item {% if post.meta('projects')|length == 1 %}portfolio__masonry-item--active{% endif %}" :class="{ 'filtered-out': selected !== '{{project.name}}' }">
                      <picture class="portfolio__masonry-pic" style="padding-top: {{ (photo.sizes['thumbnail-height'] / photo.sizes['thumbnail-width']) * 100 }}%">
                        <img class="portfolio__masonry-img"
                          src="{{photo.sizes.thumbnail|resize(10)}}"
                          srcset="{{photo.sizes.large}} 1x, {{photo.sizes.full}} 2x"
                          alt="{{ project.description }}">
                      </picture>
                    </div>
                  {% endfor %}
                  {% if post.meta('projects')|length > 1 %}
                  <div class="portfolio__masonry-item portfolio__masonry-view-more portfolio__masonry-item--active" data-project="{{project.name|slugify}}">
                    <a href="#{{project.name|slugify}}">View all +</a>
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
          </aside>
          <div class="portfolio__body">
            <div class="gallery">
              <div class="gallery__frame">
                <img class="gallery__photo"
                  src="{{post.meta('projects')[0].photos[0].sizes.hd}}"
                  {# data-webp-srcset="{{photo.sizes.thumbnail|towebp}} 1x, {{photo.sizes.medium|towebp}} 2x" #}
                  alt="{{ post.meta('projects')[0].description }}">
              </div>
              <div class="gallery__description">{{ post.meta('projects')[0].description }}</div>
            </div>
          </div>
        </section>
      </article>
    </div><!-- /content-wrapper -->
  </div>
{% endblock %}
